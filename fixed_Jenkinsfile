pipeline {
    agent any

    environment {
        DOCKER_IMAGE = 'test-env-webapp'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        GIT_COMMIT_SHORT = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Validate') {
            steps {
                sh 'docker-compose config'
                sh 'test -f docker-compose.swarm.yml'
            }
        }

        stage('Build') {
            steps {
                sh 'docker-compose build'
                sh """
                    docker tag ${DOCKER_IMAGE}:latest ${DOCKER_IMAGE}:${DOCKER_TAG}
                    docker tag ${DOCKER_IMAGE}:latest ${DOCKER_IMAGE}:${GIT_COMMIT_SHORT}
                """
            }
        }

        stage('Security Scan') {
            steps {
                sh """
                    # Сканирование на уязвимости (если установлен Trivy)
                    if command -v trivy &> /dev/null; then
                        trivy image --severity HIGH,CRITICAL ${DOCKER_IMAGE}:latest
                    fi
                """
            }
        }

        stage('Test') {
            steps {
                sh """
                    docker-compose up -d postgres redis

                    # Ожидание готовности сервисов
                    echo "Waiting for services to be healthy..."
                    timeout 60 sh -c 'until docker-compose exec -T postgres pg_isready; do sleep 1; done'
                    timeout 60 sh -c 'until docker-compose exec -T redis redis-cli ping; do sleep 1; done'

                    # Запуск тестов (теперь без || true - pipeline упадет при ошибках)
                    docker-compose run --rm webapp pytest -v --tb=short
                """
            }
            post {
                always {
                    sh 'docker-compose down -v'
                }
            }
        }

        stage('Deploy to Swarm') {
            when {
                branch 'main'
            }
            steps {
                sh """
                    # Обновление стека с новым образом
                    export IMAGE_TAG=${DOCKER_TAG}
                    docker stack deploy -c docker-compose.swarm.yml test-env --with-registry-auth
                """
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            echo "Pipeline completed successfully! Deployed version ${DOCKER_TAG}"
        }
        failure {
            echo "Pipeline failed! Check logs for details."
            // Отправка уведомлений (Slack, Email, etc.)
        }
    }
}
